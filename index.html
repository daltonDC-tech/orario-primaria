<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orario Primaria – V3.1 (GH Pages)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f6f7fb;color:#0f172a}
    header{background:#0f172a;color:#fff;padding:14px 18px} h1{font-size:18px;margin:0}
    main{padding:16px;max-width:1200px;margin:0 auto}
    .card{background:#fff;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.06);padding:14px;margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid #0f172a;background:#0f172a;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.secondary{background:#fff;color:#0f172a}
    .muted{color:#64748b;font-size:12px}
    input[type=file],input[type=text],select{padding:8px;border:1px solid #cbd5e1;border-radius:8px}
    table{border-collapse:separate;border-spacing:4px;width:100%}
    th,td{background:#f8fafc;padding:8px;border-radius:8px;font-size:12px;text-align:left}
    th{color:#475569}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid #e2e8f0;background:#eef2ff}
    .chip{display:inline-block;padding:2px 8px;border-radius:8px;font-size:11px;border:1px solid #e2e8f0;background:#f1f5f9}
    .chip.nd{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    .scroll-x{overflow-x:auto} .divider{height:1px;background:#e2e8f0;margin:8px 0}
    .badge{display:inline-block;padding:2px 6px;border-radius:6px;font-size:11px;border:1px solid #e2e8f0;background:#f1f5f9}
    #status{padding:10px 12px;border-radius:8px;background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;margin:12px 0;display:none}
  </style>
  <!-- Fallback-friendly CDNs -->
  <script defer src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header><h1>Orario Primaria – V3.1</h1></header>
<main>
  <div id="status">Caricamento librerie… se rimane così, ricarica la pagina (CTRL/CMD+R). </div>
  <div class="card">
    <div class="row">
      <div>
        <div class="muted">1) Carica Excel (supporta GIORNO/ORARIO + riga classi, incl. Anticipo/Intervallo/Mensa)</div>
        <input id="fileInput" type="file" accept=".xlsx,.xls" />
      </div>
      <button id="clearBtn" class="btn secondary">Svuota</button>
    </div>
    <div class="divider"></div>
    <div class="muted">2) Verifica classi e slot • 3) Inserisci docenti • 4) Esporta per classe/docente.</div>
  </div>
  <div id="app"></div>
</main>

<script>
(function waitForLibs(){
  const ok = window.React && window.ReactDOM && window.XLSX;
  const st = document.getElementById('status');
  if(!ok){ st.style.display='block'; return setTimeout(waitForLibs, 300); }
  st.style.display='none';
  boot();
})();

function boot(){
const SUBJECTS=[{key:'PREV',name:'Prevalente'},{key:'DEU',name:'Tedesco'},{key:'ENG',name:'Inglese'},{key:'PE',name:'Ginnastica'},{key:'REL',name:'Religione'},{key:'ART',name:'Arte'},{key:'MUS',name:'Musica'}];
const ND_LABELS={ND_ANT:'Anticipo',ND_INT:'Intervallo',ND_MEN:'Mensa'};
const DAYS=['Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Lun','Mar','Mer','Gio','Ven'];
let state={classes:[],slots:[],slotKinds:[],timetable:{},teacherMap:{}};
function makeEmptyTimetable(classes,slotCount){const tt={};classes.forEach(c=>tt[c.id]=Array.from({length:5}).map(()=>Array.from({length:slotCount}).map(()=>null)));return tt;}
function subjectKeyFromText(t){if(!t)return null;const s=t.toString().toLowerCase();if(/inglese|eng/i.test(s))return'ENG';if(/tedesco|deu/i.test(s))return'DEU';if(/relig|irc/i.test(s))return'REL';if(/arte/i.test(s))return'ART';if(/music/i.test(s))return'MUS';if(/ginn|motori|educazione fisica|ef/i.test(s))return'PE';if(/intervallo|mensa|anticipo|uscita/i.test(s))return null;return'PREV';}
function normalizeDay(d){if(!d)return null;const s=d.toString().trim();if(!s)return null;const m=DAYS.find(x=>x.toLowerCase().startsWith(s.toLowerCase().slice(0,3)));return m||s;}
function slotKindFromTimeOrLabel(v0){const v=(v0||'').toString().toLowerCase();if(/anticipo/i.test(v))return'ND_ANT';if(/intervallo/i.test(v))return'ND_INT';if(/mensa/i.test(v))return'ND_MEN';return'LESSON';}
function parseTabOrarioAoa(aoa){let hdrRow=-1,colG=-1,colO=-1;for(let r=0;r<Math.min(10,aoa.length);r++){const row=aoa[r]||[];for(let c=0;c<row.length;c++){const v=(row[c]||'').toString().toLowerCase();if(v==='giorno')colG=c;if(v==='orario')colO=c;}if(colG!==-1&&colO!==-1){hdrRow=r;break;}colG=-1;colO=-1;}if(hdrRow===-1)return null;const classRow=aoa[hdrRow+1]||[];const classes=[];for(let c=0;c<classRow.length;c++){const val=classRow[c];if(val&&typeof val==='string'&&/\b[1-5][A-Z]\b/i.test(val.trim())){classes.push({col:c,id:'C'+val.trim(),name:val.trim()});}}if(classes.length===0){for(let c=colO+1;c<classRow.length;c++){const val=classRow[c];if(val)classes.push({col:c,id:'C'+c,name:String(val)});}}
const rows=aoa.slice(hdrRow+2);const slotLabels=[],slotKinds=[],dayRows=[];let currentDay=null;for(let i=0;i<rows.length;i++){const row=rows[i]||[];const dval=normalizeDay(row[colG]);if(dval)currentDay=dval;const time=(row[colO]||'').toString();if(!time)continue;const kind=slotKindFromTimeOrLabel(time);if(!slotLabels.includes(time)){slotLabels.push(time);slotKinds.push(kind);}dayRows.push({day:currentDay,time,row,kind});}
const uniqDays=[];for(const dr of dayRows){if(!dr.day)continue;const d=dr.day.slice(0,3);if(!uniqDays.find(x=>x===d)&&uniqDays.length<5)uniqDays.push(d);}
const tt={};classes.forEach(c=>tt[c.id]=Array.from({length:5}).map(()=>Array.from({length:slotLabels.length}).map(()=>null)));const dayIndex=(d3)=>uniqDays.indexOf((d3||'').slice(0,3));for(const dr of dayRows){const di=dayIndex(dr.day);if(di<0)continue;const sIdx=slotLabels.indexOf(dr.time);if(sIdx<0)continue;if(dr.kind!=='LESSON'){for(const cls of classes){tt[cls.id][di][sIdx]={subjKey:dr.kind};}continue;}for(const cls of classes){const cell=dr.row[cls.col];if(!cell)continue;const key=subjectKeyFromText(cell);if(!key)continue;tt[cls.id][di][sIdx]={subjKey:key};}}
return{classes:classes.map(c=>({id:c.id,name:c.name})),slots:slotLabels,slotKinds:slotKinds,timetable:tt};}
let stateInit=false;function initEmpty(){state.classes=Array.from({length:10}).map((_,i)=>({id:'C'+(i+1),name:'Classe '+(i+1)}));state.slots=['7:30-8:00','8:00-8:55','8:55-9:50','10:10-11:05','11:05-12:00','13:30-14:30'];state.slotKinds=['ND_ANT','LESSON','LESSON','LESSON','LESSON','LESSON'];state.timetable=makeEmptyTimetable(state.classes,state.slots.length);for(const cid of state.classes.map(c=>c.id)){for(let d=0;d<5;d++){for(let s=0;s<state.slots.length;s++){const k=state.slotKinds[s];if(k!=='LESSON')state.timetable[cid][d][s]={subjKey:k};}}}state.teacherMap={};}
function handleFile(file){const reader=new FileReader();reader.onload=(e)=>{const data=new Uint8Array(e.target.result);const wb=XLSX.read(data,{type:'array'});const sheetName=wb.SheetNames[0];const aoa=XLSX.utils.sheet_to_json(wb.Sheets[sheetName],{header:1});const parsed=parseTabOrarioAoa(aoa);if(parsed){state.classes=parsed.classes;state.slots=parsed.slots;state.slotKinds=parsed.slotKinds;state.timetable=parsed.timetable;state.teacherMap={};render();alert('Import riuscito. Verifica classi/slot e completa i docenti.');return;}alert('Formato non riconosciuto. Usa GIORNO/ORARIO + riga classi.');};reader.readAsArrayBuffer(file);}
function setClassName(i,n){state.classes[i].name=n;render();}
function setSlotLabel(i,l){state.slots[i]=l;render();}
function setTeacher(cid,sk,v){if(!state.teacherMap[cid])state.teacherMap[cid]={};state.teacherMap[cid][sk]=v;render();}
function setCell(cid,d,s,sk){if(state.slotKinds[s]!=='LESSON')return;state.timetable[cid][d][s]=sk?{subjKey:sk}:null;render();}
function exportPerClasse(){const wb=XLSX.utils.book_new();for(const cls of state.classes){const rows=[['',...state.slots]];for(let d=0;d<5;d++){const dayName=['Lun','Mar','Mer','Gio','Ven'][d];const row=[dayName];for(let s=0;s<state.slots.length;s++){const kind=state.slotKinds[s];const cell=state.timetable[cls.id]?.[d]?.[s];if(kind!=='LESSON'){row.push(ND_LABELS[kind]||'');continue;}row.push(cell?(SUBJECTS.find(x=>x.key===cell.subjKey)?.name||cell.subjKey):'');}rows.push(row);}const ws=XLSX.utils.aoa_to_sheet(rows);XLSX.utils.book_append_sheet(wb,ws,cls.name.substring(0,28));}XLSX.writeFile(wb,'orario_per_classe.xlsx');}
function exportPerDocente(){const asg={};for(const cls of state.classes){const tmap=state.teacherMap[cls.id]||{};for(let d=0;d<5;d++){for(let s=0;s<state.slots.length;s++){if(state.slotKinds[s]!=='LESSON')continue;const cell=state.timetable[cls.id]?.[d]?.[s];if(!cell)continue;const subj=cell.subjKey;const t=tmap[subj]||'(Docente non assegnato)';if(!asg[t])asg[t]=[];asg[t].push({classe:cls.name,giorno:['Lun','Mar','Mer','Gio','Ven'][d],slot:state.slots[s],materia:SUBJECTS.find(x=>x.key===subj)?.name||subj});}}}const wb=XLSX.utils.book_new();for(const t of Object.keys(asg)){const rows=[['Classe','Giorno','Orario','Materia']];asg[t].forEach(a=>rows.push([a.classe,a.giorno,a.slot,a.materia]));const ws=XLSX.utils.aoa_to_sheet(rows);XLSX.utils.book_append_sheet(wb,ws,t.substring(0,28));}XLSX.writeFile(wb,'orario_per_docente.xlsx');}
function TeacherPanel(){return React.createElement('div',{className:'card'},React.createElement('div',{className:'muted'},'Assegna docenti per classe/materia (usato nell\'export per docente):'),state.classes.map(c=>React.createElement('div',{key:c.id,className:'row'},React.createElement('div',{className:'pill'},c.name),SUBJECTS.map(subj=>React.createElement('div',{key:subj.key},React.createElement('div',{className:'muted'},subj.name),React.createElement('input',{type:'text',placeholder:'Nome docente',value:(state.teacherMap[c.id]?.[subj.key]||''),onChange:(e)=>setTeacher(c.id,subj.key,e.target.value)}))))));}
function Tables(){return React.createElement('div',{className:'card'},state.classes.map(c=>React.createElement('div',{key:c.id,className:'card'},React.createElement('div',{className:'row'},React.createElement('span',{className:'badge'},c.name)),React.createElement('div',{className:'scroll-x'},React.createElement('table',{},[React.createElement('thead',{key:'h'},React.createElement('tr',{},[React.createElement('th',{key:'g'},'Giorno'),...state.slots.map((sl,i)=>React.createElement('th',{key:i},sl))])),React.createElement('tbody',{key:'b'},['Lun','Mar','Mer','Gio','Ven'].map((dname,didx)=>React.createElement('tr',{key:dname},[React.createElement('td',{key:'dn'},dname),...state.slots.map((sl,sidx)=>{const kind=state.slotKinds[sidx]||'LESSON';if(kind!=='LESSON')return React.createElement('td',{key:sidx},React.createElement('span',{className:'chip nd'},ND_LABELS[kind]||''));const current=state.timetable[c.id]?.[didx]?.[sidx]?.subjKey||'';return React.createElement('td',{key:sidx},React.createElement('select',{value:current,onChange:(e)=>setCell(c.id,didx,sidx,e.target.value||null)},[React.createElement('option',{key:'',value:''},'—')].concat(SUBJECTS.map(subj=>React.createElement('option',{key:subj.key,value:subj.key},subj.name)))));} )]))])))));}
function App(){React.useEffect(()=>{const input=document.getElementById('fileInput');const clearBtn=document.getElementById('clearBtn');input.onchange=(e)=>e.target.files&&handleFile(e.target.files[0]);clearBtn.onclick=()=>{initEmpty();render();};if(!stateInit){initEmpty();stateInit=true;render();}},[]);return React.createElement('div',{},[React.createElement('div',{className:'card',key:'meta'},React.createElement('div',{className:'muted'},'Classi e slot (editabili):'),React.createElement('div',{className:'row'},React.createElement('div',{},React.createElement('div',{className:'muted'},'Classi'),React.createElement('div',{className:'row'},state.classes.map((c,idx)=>React.createElement('input',{key:c.id,type:'text',value:c.name,onChange:(e)=>setClassName(idx,e.target.value)}))),),React.createElement('div',{},React.createElement('div',{className:'muted'},'Etichette orari'),React.createElement('div',{className:'row'},state.slots.map((sl,i)=>React.createElement('input',{key:i,type:'text',value:sl,onChange:(e)=>setSlotLabel(i,e.target.value)}))))),),React.createElement(TeacherPanel,{key:'teachers'}),React.createElement(Tables,{key:'tables'}),React.createElement('div',{className:'card',key:'export'},React.createElement('div',{className:'row'},React.createElement('button',{className:'btn',onClick:exportPerClasse},'Esporta Excel per classe'),React.createElement('button',{className:'btn secondary',onClick:exportPerDocente},'Esporta Excel per docente')))]);}
function render(){ReactDOM.createRoot(document.getElementById('app')).render(React.createElement(App));}
render();
}
</script>
</body>
</html>
